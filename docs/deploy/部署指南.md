# JSite 部署指南

## 目录

1. [环境要求](#1-环境要求)
2. [开发环境部署](#2-开发环境部署)
3. [生产环境部署](#3-生产环境部署)
4. [Docker部署](#4-docker部署)
5. [常见问题](#5-常见问题)

---

## 1. 环境要求

### 1.1 软件环境

| 软件 | 版本要求 | 说明 |
|------|----------|------|
| JDK | 17+ | 后端运行环境 |
| Node.js | 18+ | 前端构建环境 |
| MySQL | 8.0+ | 数据库 |
| Redis | 6.0+ | 缓存服务 |
| Nginx | 1.20+ | 反向代理（生产环境） |

### 1.2 硬件要求

**开发环境：**
- CPU: 2核+
- 内存: 4GB+
- 硬盘: 20GB+

**生产环境（推荐）：**
- CPU: 4核+
- 内存: 8GB+
- 硬盘: 50GB+

---

## 2. 开发环境部署

### 2.1 数据库准备

1. 创建数据库：
```sql
CREATE DATABASE jsite DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

2. 执行初始化脚本：
```bash
# 导入核心表结构和数据
mysql -u root -p jsite < jsite-admin/src/main/resources/db/jsite.sql

# 导入代码生成模块表
mysql -u root -p jsite < jsite-admin/src/main/resources/db/gen_table.sql
```

### 2.2 Redis准备

确保Redis服务已启动：
```bash
# Windows
redis-server.exe

# Linux
redis-server /etc/redis/redis.conf
```

### 2.3 后端启动

1. 修改配置文件 `jsite-admin/src/main/resources/application-dev.yml`：
```yaml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/jsite?useUnicode=true&characterEncoding=utf8&zeroDateTimeBehavior=convertToNull&useSSL=false&serverTimezone=GMT%2B8
    username: your_username
    password: your_password
  redis:
    host: localhost
    port: 6379
    password: # 如果有密码填写
```

2. 启动后端服务：
```bash
cd jsite-admin
mvn spring-boot:run -Dspring.profiles.active=dev
```

或使用IDE直接运行 `JsiteApplication.java`

### 2.4 前端启动

1. 安装依赖：
```bash
cd jsite-ui
npm install
# 或使用 pnpm
pnpm install
```

2. 启动开发服务器：
```bash
npm run dev
```

3. 访问 http://localhost:5173

---

## 3. 生产环境部署

### 3.1 后端打包

```bash
cd jsite-admin
mvn clean package -Dmaven.test.skip=true
```

打包完成后，jar包位于 `target/jsite-admin-1.0.0.jar`

### 3.2 前端打包

```bash
cd jsite-ui
npm run build
```

打包完成后，静态文件位于 `dist/` 目录

### 3.3 后端部署

1. 上传jar包到服务器
2. 创建配置文件 `application-prod.yml`
3. 启动服务：

```bash
# 前台启动
java -jar jsite-admin-1.0.0.jar --spring.profiles.active=prod

# 后台启动
nohup java -jar jsite-admin-1.0.0.jar --spring.profiles.active=prod > app.log 2>&1 &

# 使用systemd管理
sudo systemctl start jsite
```

**systemd服务配置示例** (`/etc/systemd/system/jsite.service`)：
```ini
[Unit]
Description=JSite Admin Service
After=syslog.target network.target

[Service]
User=www-data
ExecStart=/usr/bin/java -Xms512m -Xmx1024m -jar /opt/jsite/jsite-admin-1.0.0.jar --spring.profiles.active=prod
SuccessExitStatus=143
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
```

### 3.4 Nginx配置

```nginx
upstream jsite-backend {
    server 127.0.0.1:8080;
}

server {
    listen 80;
    server_name your-domain.com;

    # 前端静态资源
    location / {
        root /opt/jsite/dist;
        index index.html;
        try_files $uri $uri/ /index.html;
    }

    # 后端API代理
    location /api/ {
        proxy_pass http://jsite-backend/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # WebSocket支持（如需要）
    location /ws/ {
        proxy_pass http://jsite-backend/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
```

---

## 4. Docker部署

### 4.1 Dockerfile

**后端Dockerfile** (`jsite-admin/Dockerfile`)：
```dockerfile
FROM openjdk:17-jdk-slim

WORKDIR /app

COPY target/jsite-admin-1.0.0.jar app.jar

ENV JAVA_OPTS="-Xms512m -Xmx1024m"
ENV SPRING_PROFILES_ACTIVE="prod"

EXPOSE 8080

ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -jar app.jar --spring.profiles.active=$SPRING_PROFILES_ACTIVE"]
```

**前端Dockerfile** (`jsite-ui/Dockerfile`)：
```dockerfile
FROM node:18-alpine as builder

WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
RUN npm run build

FROM nginx:alpine
COPY --from=builder /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```

### 4.2 Docker Compose

**docker-compose.yml**：
```yaml
version: '3.8'

services:
  mysql:
    image: mysql:8.0
    container_name: jsite-mysql
    environment:
      MYSQL_ROOT_PASSWORD: root123456
      MYSQL_DATABASE: jsite
    ports:
      - "3306:3306"
    volumes:
      - mysql-data:/var/lib/mysql
      - ./jsite-admin/src/main/resources/db:/docker-entrypoint-initdb.d
    networks:
      - jsite-network

  redis:
    image: redis:7-alpine
    container_name: jsite-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - jsite-network

  backend:
    build: ./jsite-admin
    container_name: jsite-backend
    depends_on:
      - mysql
      - redis
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/jsite?useUnicode=true&characterEncoding=utf8&serverTimezone=GMT%2B8
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: root123456
      SPRING_REDIS_HOST: redis
    ports:
      - "8080:8080"
    networks:
      - jsite-network

  frontend:
    build: ./jsite-ui
    container_name: jsite-frontend
    depends_on:
      - backend
    ports:
      - "80:80"
    networks:
      - jsite-network

volumes:
  mysql-data:
  redis-data:

networks:
  jsite-network:
    driver: bridge
```

### 4.3 启动Docker服务

```bash
# 构建并启动所有服务
docker-compose up -d --build

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f backend

# 停止服务
docker-compose down
```

---

## 5. 常见问题

### 5.1 后端启动失败

**问题：数据库连接失败**
- 检查MySQL服务是否启动
- 检查数据库配置是否正确
- 检查数据库用户权限

**问题：Redis连接失败**
- 检查Redis服务是否启动
- 检查Redis配置是否正确

### 5.2 前端访问404

**原因：Nginx配置问题**
- 确保 `try_files` 配置正确
- 确保静态资源路径正确

### 5.3 跨域问题

**解决方案：**
1. 后端已配置CORS，检查 `CorsConfig.java`
2. 前端开发环境使用代理
3. 生产环境使用Nginx反向代理

### 5.4 内存不足

**JVM参数调优：**
```bash
java -Xms512m -Xmx1024m -XX:+UseG1GC -jar app.jar
```

---

## 附录

### 默认账号

| 账号 | 密码 | 说明 |
|------|------|------|
| admin | admin123 | 超级管理员 |

### 端口说明

| 端口 | 服务 |
|------|------|
| 8080 | 后端服务 |
| 5173 | 前端开发服务 |
| 3306 | MySQL |
| 6379 | Redis |
| 80 | Nginx |

---

*文档版本：1.0.0*
*更新日期：2026-01-17*
